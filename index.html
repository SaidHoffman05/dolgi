<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Семейные Долги</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #f8f9fc;
            --accent-color: #2e59d9;
        }
        
        body {
            background-color: var(--secondary-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
        }
        
        .nav-tabs .nav-link {
            color: #6e707e;
            font-weight: 500;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: #6e707e;
        }
        
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .calculator {
            background-color: #f8f9fa;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .calculator-display {
            background-color: white;
            border: 1px solid #e3e6f0;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            text-align: right;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .calculator-btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .nav-tabs .nav-link {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .table-responsive {
                margin-left: -15px;
                margin-right: -15px;
            }
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hand-holding-usd me-2"></i>Семейные Долги
            </a>
            <div id="user-menu" class="d-flex align-items-center">
                <span class="navbar-text text-white me-2" id="user-info"></span>
                <button class="btn btn-outline-light btn-sm" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container">
        <!-- Форма входа -->
        <div id="login-form" class="card shadow-lg">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-sign-in-alt me-2"></i>Вход в систему</h2>
                    <p class="text-muted">Введите свои учетные данные</p>
                </div>
                <div id="login-error" class="alert alert-danger d-none mb-3"></div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Логин</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt me-1"></i>Войти
                    </button>
                </form>
            </div>
        </div>

        <!-- Основное приложение -->
        <div id="app" class="d-none">
            <!-- Вкладки -->
            <ul class="nav nav-tabs mb-4" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" id="debts-tab" data-bs-toggle="tab" href="#debts-content">
                        <i class="fas fa-list me-1"></i> Долги
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="calculator-tab" data-bs-toggle="tab" href="#calculator-content">
                        <i class="fas fa-calculator me-1"></i> Калькулятор
                    </a>
                </li>
                <li class="nav-item admin-only">
                    <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users-content">
                        <i class="fas fa-users me-1"></i> Пользователи
                    </a>
                </li>
            </ul>

            <!-- Контент вкладок -->
            <div class="tab-content">
                <!-- Вкладка долгов -->
                <div class="tab-pane fade show active" id="debts-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list me-2"></i>Список долгов</h4>
                        <button class="btn btn-success admin-only" id="add-debt-btn">
                            <i class="fas fa-plus me-1"></i> Добавить
                        </button>
                    </div>
                    
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Кто должен</th>
                                            <th>Кому должен</th>
                                            <th>Сумма</th>
                                            <th>Описание</th>
                                            <th>Дата</th>
                                            <th class="admin-only">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="debts-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Вкладка калькулятора -->
                <div class="tab-pane fade" id="calculator-content">
                    <div class="row">
                        <div class="col-md-6">
                            <h4><i class="fas fa-calculator me-2"></i>Калькулятор долгов</h4>
                            <div class="calculator shadow">
                                <div class="calculator-display" id="calc-display">0</div>
                                <div class="row">
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('7')">7</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('8')">8</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('9')">9</button></div>
                                    <div class="col-3"><button class="btn btn-danger calculator-btn" onclick="clearCalc()">C</button></div>
                                </div>
                                <div class="row">
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('4')">4</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('5')">5</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('6')">6</button></div>
                                    <div class="col-3"><button class="btn btn-warning calculator-btn" onclick="calcInput('+')">+</button></div>
                                </div>
                                <div class="row">
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('1')">1</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('2')">2</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('3')">3</button></div>
                                    <div class="col-3"><button class="btn btn-warning calculator-btn" onclick="calcInput('-')">-</button></div>
                                </div>
                                <div class="row">
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('0')">0</button></div>
                                    <div class="col-3"><button class="btn btn-secondary calculator-btn" onclick="calcInput('.')">.</button></div>
                                    <div class="col-6"><button class="btn btn-primary calculator-btn" onclick="calculate()">=</button></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4><i class="fas fa-info-circle me-2"></i>Инструкция</h4>
                            <div class="card shadow">
                                <div class="card-body">
                                    <p>Используйте калькулятор для расчета долгов:</p>
                                    <ul>
                                        <li>Вводите суммы с помощью цифр</li>
                                        <li>Используйте "+" и "-" для сложения/вычитания</li>
                                        <li>Нажмите "=" для получения результата</li>
                                        <li>Кнопка "C" очищает калькулятор</li>
                                    </ul>
                                    <p class="mb-0">Результат можно использовать при добавлении новых долгов.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Вкладка пользователей (только для админа) -->
                <div class="tab-pane fade" id="users-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-users me-2"></i>Управление пользователями</h4>
                        <button class="btn btn-success" id="add-user-btn">
                            <i class="fas fa-plus me-1"></i> Добавить
                        </button>
                    </div>
                    
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Логин</th>
                                            <th>Роль</th>
                                            <th>Дата регистрации</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования долга -->
    <div class="modal fade" id="debtModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="debtModalTitle">Добавить долг</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="debt-error" class="alert alert-danger d-none mb-3"></div>
                    <form id="debtForm">
                        <div class="mb-3">
                            <label for="debt-from" class="form-label">Кто должен</label>
                            <input type="text" class="form-control" id="debt-from" required>
                        </div>
                        <div class="mb-3">
                            <label for="debt-to" class="form-label">Кому должен</label>
                            <input type="text" class="form-control" id="debt-to" required>
                        </div>
                        <div class="mb-3">
                            <label for="debt-amount" class="form-label">Сумма (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="debt-amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="debt-description" class="form-label">Описание</label>
                            <textarea class="form-control" id="debt-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="debt-date" class="form-label">Дата</label>
                            <input type="date" class="form-control" id="debt-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="save-debt-btn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования пользователя -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Добавить пользователя</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="user-error" class="alert alert-danger d-none mb-3"></div>
                    <form id="userForm">
                        <div class="mb-3">
                            <label for="user-username" class="form-label">Логин</label>
                            <input type="text" class="form-control" id="user-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-password" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="user-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-role" class="form-label">Роль</label>
                            <select class="form-select" id="user-role" required>
                                <option value="user">Пользователь</option>
                                <option value="admin">Администратор</option>
                                <option value="owner">Владелец</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="save-user-btn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Глобальные переменные
    let currentUser = null;
    let currentDebtId = null;
    let currentUserId = null;
    let calcValue = '0';
    let calcOperation = '';
    let calcPrevValue = '0';

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        initDatabase();
        
        // Проверка авторизации
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showApp();
            } catch(e) {
                localStorage.removeItem('currentUser');
                showLogin();
            }
        } else {
            showLogin();
        }

        // Обработчики событий
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
        
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('add-debt-btn').addEventListener('click', showAddDebtModal);
        document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
        document.getElementById('save-debt-btn').addEventListener('click', saveDebt);
        document.getElementById('save-user-btn').addEventListener('click', saveUser);
        
        // Инициализация калькулятора
        updateCalcDisplay();
    });

    // Инициализация базы данных
    function initDatabase() {
        if (!localStorage.getItem('users')) {
            const users = [
                { 
                    id: 1, 
                    username: 'admin', 
                    password: 'admin123', 
                    role: 'owner', 
                    created_at: new Date().toISOString() 
                },
                { 
                    id: 2, 
                    username: 'user1', 
                    password: '123456', 
                    role: 'user', 
                    created_at: new Date().toISOString() 
                }
            ];
            localStorage.setItem('users', JSON.stringify(users));
        }
        
        if (!localStorage.getItem('debts')) {
            const debts = [
                {
                    id: 1,
                    from_user: 'Иван',
                    to_user: 'Мария',
                    amount: 1500.50,
                    description: 'За продукты',
                    date: new Date().toISOString(),
                    created_at: new Date().toISOString()
                },
                {
                    id: 2,
                    from_user: 'Петр',
                    to_user: 'Ольга',
                    amount: 2500,
                    description: 'За ремонт',
                    date: new Date().toISOString(),
                    created_at: new Date().toISOString()
                }
            ];
            localStorage.setItem('debts', JSON.stringify(debts));
        }
    }

    // Обработка входа
    function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorElement = document.getElementById('login-error');

        if (!username || !password) {
            showError(errorElement, 'Заполните все поля');
            return;
        }

        const users = JSON.parse(localStorage.getItem('users')) || [];
        const user = users.find(u => u.username === username && u.password === password);
        
        if (user) {
            currentUser = {
                id: user.id,
                username: user.username,
                role: user.role
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
        } else {
            showError(errorElement, 'Неверный логин или пароль');
        }
    }

    // Выход из системы
    function logout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        showLogin();
    }

    // Показать основное приложение
    function showApp() {
        document.getElementById('login-form').classList.add('d-none');
        document.getElementById('app').classList.remove('d-none');
        updateUIForRole();
        loadDebts();
        loadUsers();
    }

    // Показать форму входа
    function showLogin() {
        document.getElementById('login-form').classList.remove('d-none');
        document.getElementById('app').classList.add('d-none');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('username').focus();
    }

    // Обновить интерфейс в зависимости от роли
    function updateUIForRole() {
        const userInfoEl = document.getElementById('user-info');
        if (userInfoEl) {
            let roleName = '';
            switch(currentUser.role) {
                case 'owner': roleName = 'Владелец'; break;
                case 'admin': roleName = 'Администратор'; break;
                default: roleName = 'Пользователь';
            }
            userInfoEl.textContent = `${currentUser.username} (${roleName})`;
        }

        // Показываем/скрываем элементы для админа и владельца
        const isAdmin = currentUser.role === 'admin' || currentUser.role === 'owner';
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? '' : 'none';
        });
    }

    // Загрузить список долгов
    function loadDebts() {
        const debts = JSON.parse(localStorage.getItem('debts')) || [];
        const table = document.getElementById('debts-table');
        
        table.innerHTML = debts.map(debt => {
            const canEdit = currentUser.role === 'admin' || currentUser.role === 'owner';
            const actions = canEdit ? `
                <td class="action-buttons">
                    <button class="btn btn-sm btn-warning" onclick="editDebt(${debt.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDebt(${debt.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            ` : '<td></td>';
            
            return `
                <tr>
                    <td>${debt.from_user}</td>
                    <td>${debt.to_user}</td>
                    <td>${debt.amount.toFixed(2)} ₽</td>
                    <td>${debt.description || '-'}</td>
                    <td>${formatDate(debt.date)}</td>
                    ${actions}
                </tr>
            `;
        }).join('');
    }

    // Показать модальное окно добавления долга
    function showAddDebtModal() {
        currentDebtId = null;
        document.getElementById('debtModalTitle').textContent = 'Добавить долг';
        document.getElementById('debt-from').value = '';
        document.getElementById('debt-to').value = '';
        document.getElementById('debt-amount').value = '';
        document.getElementById('debt-description').value = '';
        document.getElementById('debt-date').valueAsDate = new Date();
        hideError('debt-error');
        
        const modal = new bootstrap.Modal(document.getElementById('debtModal'));
        modal.show();
    }

    // Редактировать долг
    function editDebt(id) {
        const debts = JSON.parse(localStorage.getItem('debts'));
        const debt = debts.find(d => d.id === id);
        
        if (debt) {
            currentDebtId = id;
            document.getElementById('debtModalTitle').textContent = 'Редактировать долг';
            document.getElementById('debt-from').value = debt.from_user;
            document.getElementById('debt-to').value = debt.to_user;
            document.getElementById('debt-amount').value = debt.amount;
            document.getElementById('debt-description').value = debt.description || '';
            document.getElementById('debt-date').value = debt.date.split('T')[0];
            hideError('debt-error');
            
            const modal = new bootstrap.Modal(document.getElementById('debtModal'));
            modal.show();
        }
    }

    // Сохранить долг
    function saveDebt() {
        const debtData = {
            id: currentDebtId || Date.now(),
            from_user: document.getElementById('debt-from').value.trim(),
            to_user: document.getElementById('debt-to').value.trim(),
            amount: parseFloat(document.getElementById('debt-amount').value),
            description: document.getElementById('debt-description').value.trim(),
            date: document.getElementById('debt-date').value,
            created_at: new Date().toISOString()
        };

        if (!debtData.from_user || !debtData.to_user || isNaN(debtData.amount) {
            showError('debt-error', 'Заполните все обязательные поля');
            return;
        }

        let debts = JSON.parse(localStorage.getItem('debts'));
        
        if (currentDebtId) {
            const index = debts.findIndex(d => d.id === currentDebtId);
            debts[index] = debtData;
        } else {
            debts.push(debtData);
        }

        localStorage.setItem('debts', JSON.stringify(debts));
        bootstrap.Modal.getInstance(document.getElementById('debtModal')).hide();
        loadDebts();
    }

    // Удалить долг
    function deleteDebt(id) {
        if (confirm('Вы уверены, что хотите удалить этот долг?')) {
            let debts = JSON.parse(localStorage.getItem('debts'));
            debts = debts.filter(d => d.id !== id);
            localStorage.setItem('debts', JSON.stringify(debts));
            loadDebts();
        }
    }

    // Загрузить список пользователей
    function loadUsers() {
        const users = JSON.parse(localStorage.getItem('users'));
        const table = document.getElementById('users-table');
        
        if (!table) return;
        
        table.innerHTML = users.map(user => {
            const canEdit = currentUser.role === 'owner' || (currentUser.role === 'admin' && user.role !== 'owner');
            const isCurrentUser = user.id === currentUser.id;
            
            let roleName = '';
            switch(user.role) {
                case 'owner': roleName = 'Владелец'; break;
                case 'admin': roleName = 'Администратор'; break;
                default: roleName = 'Пользователь';
            }
            
            return `
                <tr>
                    <td>${user.username}</td>
                    <td>${roleName}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td class="action-buttons">
                        ${(currentUser.role === 'admin' || currentUser.role === 'owner') ? `
                        <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})" ${!canEdit ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" ${isCurrentUser || user.role === 'owner' ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Показать модальное окно добавления пользователя
    function showAddUserModal() {
        currentUserId = null;
        document.getElementById('userModalTitle').textContent = 'Добавить пользователя';
        document.getElementById('user-username').value = '';
        document.getElementById('user-password').value = '';
        document.getElementById('user-role').value = 'user';
        hideError('user-error');
        
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }

    // Редактировать пользователя
    function editUser(id) {
        const users = JSON.parse(localStorage.getItem('users'));
        const user = users.find(u => u.id === id);
        
        if (user) {
            currentUserId = id;
            document.getElementById('userModalTitle').textContent = 'Редактировать пользователя';
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = user.role;
            hideError('user-error');
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }
    }

    // Сохранить пользователя
    function saveUser() {
        const username = document.getElementById('user-username').value.trim();
        const password = document.getElementById('user-password').value;
        const role = document.getElementById('user-role').value;

        if (!username || !password) {
            showError('user-error', 'Заполните все поля');
            return;
        }

        // Проверка прав для установки роли
        if (currentUser.role !== 'owner' && role === 'owner') {
            showError('user-error', 'Только владелец может создавать других владельцев');
            return;
        }

        let users = JSON.parse(localStorage.getItem('users'));
        const userData = {
            id: currentUserId || Date.now(),
            username,
            password,
            role,
            created_at: new Date().toISOString()
        };

        if (currentUserId) {
            const index = users.findIndex(u => u.id === currentUserId);
            
            // Проверка прав на редактирование
            if (users[index].role === 'owner' && currentUser.role !== 'owner') {
                showError('user-error', 'Только владелец может редактировать других владельцев');
                return;
            }
            
            users[index] = userData;
        } else {
            // Проверка на существующего пользователя
            if (users.some(u => u.username === username)) {
                showError('user-error', 'Пользователь с таким логином уже существует');
                return;
            }
            users.push(userData);
        }

        localStorage.setItem('users', JSON.stringify(users));
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUsers();
        
        // Если редактировали текущего пользователя - обновляем данные
        if (currentUserId === currentUser?.id) {
            currentUser.username = username;
            currentUser.role = role;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUIForRole();
        }
    }

    // Удалить пользователя
    function deleteUser(id) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            let users = JSON.parse(localStorage.getItem('users'));
            users = users.filter(u => u.id !== id);
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
        }
    }

    // Функции калькулятора
    function calcInput(value) {
        if (calcValue === '0' && value !== '.') {
            calcValue = value;
        } else {
            calcValue += value;
        }
        updateCalcDisplay();
    }

    function clearCalc() {
        calcValue = '0';
        calcOperation = '';
        calcPrevValue = '0';
        updateCalcDisplay();
    }

    function calculate() {
        if (calcOperation === '+') {
            calcValue = (parseFloat(calcPrevValue) + parseFloat(calcValue)).toString();
        } else if (calcOperation === '-') {
            calcValue = (parseFloat(calcPrevValue) - parseFloat(calcValue)).toString();
        }
        calcOperation = '';
        calcPrevValue = '0';
        updateCalcDisplay();
    }

    function updateCalcDisplay() {
        document.getElementById('calc-display').textContent = calcValue;
    }

    // Вспомогательные функции
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('ru-RU');
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.classList.remove('d-none');
            setTimeout(() => element.classList.add('d-none'), 5000);
        }
    }

    function hideError(elementId) {
        const element = document.getElementById(elementId);
        if (element) element.classList.add('d-none');
    }
    </script>
</body>
</html>
