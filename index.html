<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Семейные Долги</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --mobile-padding: 15px;
        }
        body {
            background-color: #f8f9fa;
            padding-top: 56px;
            padding-bottom: 2rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            margin-bottom: 1rem;
        }
        .admin-only {
            display: none;
        }
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            padding: 1rem 1.25rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
            background: transparent;
        }
        .table th {
            border-top: none;
            font-weight: 500;
            white-space: nowrap;
        }
        .table td {
            vertical-align: middle;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .action-buttons .btn {
            padding: 0.3rem 0.5rem;
            margin: 0 2px;
        }
        .modal-content {
            border-radius: 0.5rem;
        }
        .btn-mobile {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        .form-control, .form-select {
            padding: 0.75rem 1rem;
        }
        @media (max-width: 768px) {
            body {
                padding-top: 56px;
                padding-bottom: 1rem;
            }
            .container {
                padding-left: var(--mobile-padding);
                padding-right: var(--mobile-padding);
            }
            .nav-tabs .nav-link {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }
            .table-responsive {
                margin-left: calc(-1 * var(--mobile-padding));
                margin-right: calc(-1 * var(--mobile-padding));
                width: calc(100% + 2 * var(--mobile-padding));
            }
            .table {
                font-size: 0.85rem;
            }
            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            .modal-body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hand-holding-usd me-2"></i>Семейные Долги
            </a>
            <div id="user-menu" class="d-flex align-items-center">
                <span class="navbar-text text-white me-2" id="user-info"></span>
                <button class="btn btn-outline-light btn-sm btn-mobile" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Форма входа -->
        <div id="login-form" class="card shadow">
            <div class="card-body">
                <h2 class="text-center mb-4"><i class="fas fa-sign-in-alt me-2"></i>Вход</h2>
                <div id="login-error" class="alert alert-danger d-none mb-3"></div>
                <div class="mb-3">
                    <label for="username" class="form-label">Логин</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Пароль</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button id="login-btn" class="btn btn-primary w-100 btn-mobile">
                    <i class="fas fa-sign-in-alt me-1"></i>Войти
                </button>
            </div>
        </div>

        <!-- Основное приложение -->
        <div id="app" class="d-none">
            <div class="card shadow">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs" id="mainTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="debts-tab" data-bs-toggle="tab" href="#debts-content">
                                <i class="fas fa-list me-1"></i><span class="d-none d-md-inline">Долги</span>
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users-content">
                                <i class="fas fa-users me-1"></i><span class="d-none d-md-inline">Пользователи</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body tab-content p-0">
                    <!-- Вкладка долгов -->
                    <div class="tab-pane fade show active" id="debts-content">
                        <div class="d-flex justify-content-between align-items-center p-3 pb-0">
                            <h4 class="mb-0"><i class="fas fa-list me-2"></i>Долги</h4>
                            <button class="btn btn-success admin-only btn-mobile" id="add-debt-btn">
                                <i class="fas fa-plus"></i><span class="d-none d-md-inline"> Добавить</span>
                            </button>
                        </div>
                        <div class="table-responsive p-3">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Кто должен</th>
                                        <th>Кому должен</th>
                                        <th>Сумма</th>
                                        <th class="d-none d-md-table-cell">Описание</th>
                                        <th class="d-none d-md-table-cell">Дата</th>
                                        <th class="admin-only">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="debts-table"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Вкладка пользователей -->
                    <div class="tab-pane fade" id="users-content">
                        <div class="d-flex justify-content-between align-items-center p-3 pb-0">
                            <h4 class="mb-0"><i class="fas fa-users me-2"></i>Пользователи</h4>
                            <button class="btn btn-success admin-only btn-mobile" id="add-user-btn">
                                <i class="fas fa-plus"></i><span class="d-none d-md-inline"> Добавить</span>
                            </button>
                        </div>
                        <div class="table-responsive p-3">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Логин</th>
                                        <th>Роль</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal fade" id="debtModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="debtModalTitle">Добавить долг</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="debt-error" class="alert alert-danger d-none mb-3"></div>
                    <div class="mb-3">
                        <label for="debt-from" class="form-label">Кто должен</label>
                        <input type="text" class="form-control" id="debt-from" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-to" class="form-label">Кому должен</label>
                        <input type="text" class="form-control" id="debt-to" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-amount" class="form-label">Сумма (₽)</label>
                        <input type="number" step="0.01" class="form-control" id="debt-amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-description" class="form-label">Описание</label>
                        <textarea class="form-control" id="debt-description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-mobile" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary btn-mobile" onclick="saveDebt()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Добавить пользователя</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="user-error" class="alert alert-danger d-none mb-3"></div>
                    <div class="mb-3">
                        <label for="user-username" class="form-label">Логин</label>
                        <input type="text" class="form-control" id="user-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="user-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-role" class="form-label">Роль</label>
                        <select class="form-select" id="user-role">
                            <option value="user">Пользователь</option>
                            <option value="admin">Администратор</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-mobile" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary btn-mobile" onclick="saveUser()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Глобальные переменные
    let currentUser = null;
    let currentDebtId = null;
    let currentUserId = null;

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        // Принудительная очистка localStorage для тестирования (можно удалить)
        // localStorage.clear();
        
        initDatabase();
        
        // Проверка авторизации
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showApp();
            } catch(e) {
                console.error("Ошибка загрузки пользователя:", e);
                localStorage.removeItem('currentUser');
                showLogin();
            }
        } else {
            showLogin();
        }

        // Обработчики событий
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('add-debt-btn').addEventListener('click', showAddDebtModal);
        document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
    });

    function initDatabase() {
        if (!localStorage.getItem('users')) {
            const users = [
                { 
                    id: 1, 
                    username: 'admin', 
                    password: 'admin123', 
                    role: 'admin', 
                    created_at: new Date().toISOString() 
                },
                { 
                    id: 2, 
                    username: 'user1', 
                    password: '123456', 
                    role: 'user', 
                    created_at: new Date().toISOString() 
                }
            ];
            localStorage.setItem('users', JSON.stringify(users));
            console.log("Созданы тестовые пользователи:", users);
        }
        
        if (!localStorage.getItem('debts')) {
            localStorage.setItem('debts', JSON.stringify([]));
        }
    }

    function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorElement = document.getElementById('login-error');

        if (!username || !password) {
            showError(errorElement, 'Заполните все поля');
            return;
        }

        try {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            console.log("Попытка входа. Пользователи в системе:", users);
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                console.log("Успешный вход:", user);
                currentUser = {
                    id: user.id,
                    username: user.username,
                    role: user.role
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
            } else {
                console.log("Ошибка входа. Введенные данные:", {username, password});
                showError(errorElement, 'Неверный логин или пароль');
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
            }
        } catch (e) {
            console.error("Ошибка при входе:", e);
            showError(errorElement, 'Ошибка системы. Попробуйте позже.');
        }
    }

    function logout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        showLogin();
    }

    function showApp() {
        document.getElementById('login-form').classList.add('d-none');
        document.getElementById('app').classList.remove('d-none');
        updateUIForRole();
        loadDebts();
        loadUsers();
    }

    function showLogin() {
        document.getElementById('login-form').classList.remove('d-none');
        document.getElementById('app').classList.add('d-none');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('username').focus();
    }

    function updateUIForRole() {
        const userInfoEl = document.getElementById('user-info');
        if (userInfoEl) {
            userInfoEl.textContent = currentUser.username + 
                (currentUser.role === 'admin' ? ' (Админ)' : '');
        }

        // Показываем/скрываем элементы для админа
        const isAdmin = currentUser.role === 'admin';
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? '' : 'none';
        });
    }

    function loadDebts() {
        const debts = JSON.parse(localStorage.getItem('debts')) || [];
        const table = document.getElementById('debts-table');
        
        table.innerHTML = debts.map(debt => {
            const actions = currentUser.role === 'admin' ? `
                <td class="action-buttons">
                    <button class="btn btn-sm btn-warning" onclick="editDebt(${debt.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDebt(${debt.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            ` : '<td></td>';
            
            return `
                <tr>
                    <td>${debt.from_user}</td>
                    <td>${debt.to_user}</td>
                    <td>${debt.amount.toFixed(2)} ₽</td>
                    <td class="d-none d-md-table-cell">${debt.description || '-'}</td>
                    <td class="d-none d-md-table-cell">${formatDate(debt.created_at)}</td>
                    ${actions}
                </tr>
            `;
        }).join('');
    }

    function showAddDebtModal() {
        currentDebtId = null;
        document.getElementById('debtModalTitle').textContent = 'Добавить долг';
        document.getElementById('debt-from').value = '';
        document.getElementById('debt-to').value = '';
        document.getElementById('debt-amount').value = '';
        document.getElementById('debt-description').value = '';
        hideError('debt-error');
        
        const modal = new bootstrap.Modal(document.getElementById('debtModal'));
        modal.show();
    }

    function editDebt(id) {
        const debts = JSON.parse(localStorage.getItem('debts'));
        const debt = debts.find(d => d.id === id);
        
        if (debt) {
            currentDebtId = id;
            document.getElementById('debtModalTitle').textContent = 'Редактировать долг';
            document.getElementById('debt-from').value = debt.from_user;
            document.getElementById('debt-to').value = debt.to_user;
            document.getElementById('debt-amount').value = debt.amount;
            document.getElementById('debt-description').value = debt.description || '';
            hideError('debt-error');
            
            const modal = new bootstrap.Modal(document.getElementById('debtModal'));
            modal.show();
        }
    }

    function saveDebt() {
        const debtData = {
            id: currentDebtId || Date.now(),
            from_user: document.getElementById('debt-from').value.trim(),
            to_user: document.getElementById('debt-to').value.trim(),
            amount: parseFloat(document.getElementById('debt-amount').value),
            description: document.getElementById('debt-description').value.trim(),
            created_at: new Date().toISOString()
        };

        if (!debtData.from_user || !debtData.to_user || isNaN(debtData.amount)) {
            showError('debt-error', 'Заполните все обязательные поля');
            return;
        }

        let debts = JSON.parse(localStorage.getItem('debts'));
        
        if (currentDebtId) {
            const index = debts.findIndex(d => d.id === currentDebtId);
            debts[index] = debtData;
        } else {
            debts.push(debtData);
        }

        localStorage.setItem('debts', JSON.stringify(debts));
        bootstrap.Modal.getInstance(document.getElementById('debtModal')).hide();
        loadDebts();
    }

    function deleteDebt(id) {
        if (confirm('Вы уверены, что хотите удалить этот долг?')) {
            let debts = JSON.parse(localStorage.getItem('debts'));
            debts = debts.filter(d => d.id !== id);
            localStorage.setItem('debts', JSON.stringify(debts));
            loadDebts();
        }
    }

    function loadUsers() {
        const users = JSON.parse(localStorage.getItem('users'));
        const table = document.getElementById('users-table');
        
        if (!table) return;
        
        table.innerHTML = users.map(user => {
            const canEdit = currentUser.role === 'admin' && user.id !== 1; // Нельзя редактировать главного админа
            const isCurrentUser = user.id === currentUser.id;
            
            return `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.role === 'admin' ? 'Администратор' : 'Пользователь'}</td>
                    <td class="action-buttons">
                        ${currentUser.role === 'admin' ? `
                        <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})" ${!canEdit ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" ${isCurrentUser ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function showAddUserModal() {
        currentUserId = null;
        document.getElementById('userModalTitle').textContent = 'Добавить пользователя';
        document.getElementById('user-username').value = '';
        document.getElementById('user-password').value = '';
        document.getElementById('user-role').value = 'user';
        hideError('user-error');
        
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }

    function editUser(id) {
        const users = JSON.parse(localStorage.getItem('users'));
        const user = users.find(u => u.id === id);
        
        if (user) {
            currentUserId = id;
            document.getElementById('userModalTitle').textContent = 'Редактировать пользователя';
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = user.role;
            hideError('user-error');
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }
    }

    function saveUser() {
        const username = document.getElementById('user-username').value.trim();
        const password = document.getElementById('user-password').value;
        const role = document.getElementById('user-role').value;

        if (!username || !password) {
            showError('user-error', 'Заполните все поля');
            return;
        }

        let users = JSON.parse(localStorage.getItem('users'));
        const userData = {
            id: currentUserId || Date.now(),
            username,
            password,
            role,
            created_at: new Date().toISOString()
        };

        if (currentUserId) {
            const index = users.findIndex(u => u.id === currentUserId);
            users[index] = userData;
        } else {
            // Проверка на существующего пользователя
            if (users.some(u => u.username === username)) {
                showError('user-error', 'Пользователь с таким логином уже существует');
                return;
            }
            users.push(userData);
        }

        localStorage.setItem('users', JSON.stringify(users));
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUsers();
        
        // Если редактировали текущего пользователя - обновляем данные
        if (currentUserId === currentUser?.id) {
            currentUser.username = username;
            currentUser.role = role;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUIForRole();
        }
    }

    function deleteUser(id) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            let users = JSON.parse(localStorage.getItem('users'));
            users = users.filter(u => u.id !== id);
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
        }
    }

    // Вспомогательные функции
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('ru-RU');
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.classList.remove('d-none');
            setTimeout(() => element.classList.add('d-none'), 5000);
        }
    }

    function hideError(elementId) {
        const element = document.getElementById(elementId);
        if (element) element.classList.add('d-none');
    }
    </script>
</body>
</html>
