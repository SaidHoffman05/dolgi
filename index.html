<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Семейные Долги</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 56px;
            padding-bottom: 2rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .admin-only {
            display: none;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
            background: transparent;
        }
        .table th {
            border-top: none;
            font-weight: 500;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        @media (max-width: 768px) {
            body { padding-top: 48px; }
            .nav-tabs .nav-link { padding: 0.75rem; }
            .form-control, .btn { padding: 0.75rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hand-holding-usd me-2"></i>Семейные Долги
            </a>
            <div id="user-menu" class="d-flex align-items-center">
                <span class="navbar-text text-white me-3" id="user-info"></span>
                <button class="btn btn-outline-light btn-sm" id="logout-btn">
                    <i class="fas fa-sign-out-alt me-1"></i>Выйти
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="login-form" class="card shadow mb-4">
            <div class="card-body">
                <h2 class="text-center mb-4"><i class="fas fa-sign-in-alt me-2"></i>Вход в систему</h2>
                <div id="login-error" class="alert alert-danger d-none"></div>
                <div class="mb-3">
                    <label for="username" class="form-label">Логин</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Пароль</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button id="login-btn" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>Войти
                </button>
            </div>
        </div>

        <div id="app" class="d-none">
            <div class="card shadow">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs" id="mainTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="debts-tab" data-bs-toggle="tab" href="#debts-content">
                                <i class="fas fa-list me-2"></i>Долги
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users-content">
                                <i class="fas fa-users me-2"></i>Пользователи
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body tab-content">
                    <div class="tab-pane fade show active" id="debts-content">
                        <div class="d-flex justify-content-between mb-3">
                            <h4><i class="fas fa-list me-2"></i>Список долгов</h4>
                            <button class="btn btn-success admin-only" id="add-debt-btn">
                                <i class="fas fa-plus me-2"></i>Добавить
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Кто должен</th>
                                        <th>Кому должен</th>
                                        <th>Сумма</th>
                                        <th>Описание</th>
                                        <th>Дата</th>
                                        <th class="admin-only">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="debts-table"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="users-content">
                        <div class="d-flex justify-content-between mb-3">
                            <h4><i class="fas fa-users me-2"></i>Пользователи</h4>
                            <button class="btn btn-success admin-only" id="add-user-btn">
                                <i class="fas fa-plus me-2"></i>Добавить
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Логин</th>
                                        <th>Роль</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal fade" id="debtModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="debtModalTitle">Добавить долг</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="debt-error" class="alert alert-danger d-none"></div>
                    <div class="mb-3">
                        <label for="debt-from" class="form-label">Кто должен</label>
                        <input type="text" class="form-control" id="debt-from" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-to" class="form-label">Кому должен</label>
                        <input type="text" class="form-control" id="debt-to" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-amount" class="form-label">Сумма</label>
                        <input type="number" step="0.01" class="form-control" id="debt-amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="debt-description" class="form-label">Описание</label>
                        <textarea class="form-control" id="debt-description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveDebt()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Добавить пользователя</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="user-error" class="alert alert-danger d-none"></div>
                    <div class="mb-3">
                        <label for="user-username" class="form-label">Логин</label>
                        <input type="text" class="form-control" id="user-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="user-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-role" class="form-label">Роль</label>
                        <select class="form-select" id="user-role">
                            <option value="user">Пользователь</option>
                            <option value="admin">Администратор</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Глобальные переменные
    let currentUser = null;
    let currentDebtId = null;
    let currentUserId = null;

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
        initDatabase();
        
        // Проверка авторизации
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        }

        // Обработчики событий
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('add-debt-btn').addEventListener('click', showAddDebtModal);
        document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
        
        document.getElementById('username').focus();
    });

    function initDatabase() {
        if (!localStorage.getItem('users')) {
            const users = [
                { id: 1, username: 'admin', password: 'admin123', role: 'admin', created_at: new Date().toISOString() },
                { id: 2, username: 'user', password: 'user123', role: 'user', created_at: new Date().toISOString() }
            ];
            localStorage.setItem('users', JSON.stringify(users));
        }
        if (!localStorage.getItem('debts')) {
            localStorage.setItem('debts', JSON.stringify([]));
        }
    }

    function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorElement = document.getElementById('login-error');

        if (!username || !password) {
            showError(errorElement, 'Заполните все поля');
            return;
        }

        const users = JSON.parse(localStorage.getItem('users'));
        const user = users.find(u => u.username === username && u.password === password);

        if (user) {
            currentUser = {
                id: user.id,
                username: user.username,
                role: user.role
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
        } else {
            showError(errorElement, 'Неверный логин или пароль');
        }
    }

    function logout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        showLogin();
    }

    function showApp() {
        document.getElementById('login-form').classList.add('d-none');
        document.getElementById('app').classList.remove('d-none');
        updateUIForRole();
        loadDebts();
        loadUsers();
    }

    function showLogin() {
        document.getElementById('login-form').classList.remove('d-none');
        document.getElementById('app').classList.add('d-none');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('username').focus();
    }

    function updateUIForRole() {
        const userInfoEl = document.getElementById('user-info');
        if (userInfoEl) {
            userInfoEl.textContent = currentUser.username + (currentUser.role === 'admin' ? ' (Админ)' : '');
        }
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
        });
    }

    function loadDebts() {
        const debts = JSON.parse(localStorage.getItem('debts')) || [];
        const table = document.getElementById('debts-table');
        
        table.innerHTML = debts.map(debt => `
            <tr>
                <td>${debt.from_user}</td>
                <td>${debt.to_user}</td>
                <td>${debt.amount.toFixed(2)} ₽</td>
                <td>${debt.description || '-'}</td>
                <td>${new Date(debt.created_at).toLocaleDateString('ru-RU')}</td>
                <td class="admin-only action-buttons">
                    <button class="btn btn-sm btn-warning me-2" onclick="editDebt(${debt.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDebt(${debt.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function showAddDebtModal() {
        currentDebtId = null;
        document.getElementById('debtModalTitle').textContent = 'Добавить долг';
        document.getElementById('debt-from').value = '';
        document.getElementById('debt-to').value = '';
        document.getElementById('debt-amount').value = '';
        document.getElementById('debt-description').value = '';
        hideError('debt-error');
        new bootstrap.Modal(document.getElementById('debtModal')).show();
    }

    function editDebt(id) {
        const debts = JSON.parse(localStorage.getItem('debts'));
        const debt = debts.find(d => d.id === id);
        
        if (debt) {
            currentDebtId = id;
            document.getElementById('debtModalTitle').textContent = 'Редактировать долг';
            document.getElementById('debt-from').value = debt.from_user;
            document.getElementById('debt-to').value = debt.to_user;
            document.getElementById('debt-amount').value = debt.amount;
            document.getElementById('debt-description').value = debt.description || '';
            hideError('debt-error');
            new bootstrap.Modal(document.getElementById('debtModal')).show();
        }
    }

    function saveDebt() {
        const debtData = {
            id: currentDebtId || Date.now(),
            from_user: document.getElementById('debt-from').value.trim(),
            to_user: document.getElementById('debt-to').value.trim(),
            amount: parseFloat(document.getElementById('debt-amount').value),
            description: document.getElementById('debt-description').value.trim(),
            created_at: new Date().toISOString()
        };

        if (!debtData.from_user || !debtData.to_user || isNaN(debtData.amount)) {
            showError('debt-error', 'Заполните все обязательные поля');
            return;
        }

        let debts = JSON.parse(localStorage.getItem('debts'));
        if (currentDebtId) {
            const index = debts.findIndex(d => d.id === currentDebtId);
            debts[index] = debtData;
        } else {
            debts.push(debtData);
        }

        localStorage.setItem('debts', JSON.stringify(debts));
        bootstrap.Modal.getInstance(document.getElementById('debtModal')).hide();
        loadDebts();
    }

    function deleteDebt(id) {
        if (confirm('Вы уверены, что хотите удалить этот долг?')) {
            let debts = JSON.parse(localStorage.getItem('debts'));
            debts = debts.filter(d => d.id !== id);
            localStorage.setItem('debts', JSON.stringify(debts));
            loadDebts();
        }
    }

    function loadUsers() {
        const users = JSON.parse(localStorage.getItem('users'));
        const table = document.getElementById('users-table');
        
        table.innerHTML = users.map(user => `
            <tr>
                <td>${user.username}</td>
                <td>${user.role === 'admin' ? 'Администратор' : 'Пользователь'}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-2" onclick="editUser(${user.id})" ${user.id === currentUser.id ? 'disabled' : ''}>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" ${user.id === currentUser.id ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function showAddUserModal() {
        currentUserId = null;
        document.getElementById('userModalTitle').textContent = 'Добавить пользователя';
        document.getElementById('user-username').value = '';
        document.getElementById('user-password').value = '';
        document.getElementById('user-role').value = 'user';
        hideError('user-error');
        new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    function editUser(id) {
        const users = JSON.parse(localStorage.getItem('users'));
        const user = users.find(u => u.id === id);
        
        if (user) {
            currentUserId = id;
            document.getElementById('userModalTitle').textContent = 'Редактировать пользователя';
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = user.role;
            hideError('user-error');
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }
    }

    function saveUser() {
        const username = document.getElementById('user-username').value.trim();
        const password = document.getElementById('user-password').value;
        const role = document.getElementById('user-role').value;

        if (!username || !password) {
            showError('user-error', 'Заполните все поля');
            return;
        }

        let users = JSON.parse(localStorage.getItem('users'));
        const userData = {
            id: currentUserId || Date.now(),
            username,
            password,
            role,
            created_at: new Date().toISOString()
        };

        if (currentUserId) {
            const index = users.findIndex(u => u.id === currentUserId);
            users[index] = userData;
        } else {
            users.push(userData);
        }

        localStorage.setItem('users', JSON.stringify(users));
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUsers();
    }

    function deleteUser(id) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            let users = JSON.parse(localStorage.getItem('users'));
            users = users.filter(u => u.id !== id);
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
        }
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.classList.remove('d-none');
            setTimeout(() => element.classList.add('d-none'), 3000);
        }
    }

    function hideError(elementId) {
        const element = document.getElementById(elementId);
        if (element) element.classList.add('d-none');
    }
    </script>
</body>
</html>
